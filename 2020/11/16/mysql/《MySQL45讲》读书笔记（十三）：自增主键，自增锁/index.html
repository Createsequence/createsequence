<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"createsequence.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="此文为极客时间：MySQL实战45讲的39节的学习笔记  一、自增值的保存方式我们前面提到过，自增主键的连续性使得表在空间上排列的更紧密，提高了空间利用率，避免了页分裂。实际上，自增主键大部分情况下可以保证连续性，但是也有例外的时候。">
<meta property="og:type" content="article">
<meta property="og:title" content="《MySQL45讲》读书笔记(十三)：自增主键，自增锁">
<meta property="og:url" content="https://createsequence.github.io/2020/11/16/mysql/%E3%80%8AMySQL45%E8%AE%B2%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89%EF%BC%9A%E8%87%AA%E5%A2%9E%E4%B8%BB%E9%94%AE%EF%BC%8C%E8%87%AA%E5%A2%9E%E9%94%81/index.html">
<meta property="og:site_name" content="Createsequence&#39;s Blog">
<meta property="og:description" content="此文为极客时间：MySQL实战45讲的39节的学习笔记  一、自增值的保存方式我们前面提到过，自增主键的连续性使得表在空间上排列的更紧密，提高了空间利用率，避免了页分裂。实际上，自增主键大部分情况下可以保证连续性，但是也有例外的时候。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img.xiajibagao.top/image-20201112202134714.png">
<meta property="article:published_time" content="2020-11-15T16:00:00.000Z">
<meta property="article:modified_time" content="2020-12-24T12:01:38.000Z">
<meta property="article:author" content="Createsequence">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img.xiajibagao.top/image-20201112202134714.png">


<link rel="canonical" href="https://createsequence.github.io/2020/11/16/mysql/%E3%80%8AMySQL45%E8%AE%B2%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89%EF%BC%9A%E8%87%AA%E5%A2%9E%E4%B8%BB%E9%94%AE%EF%BC%8C%E8%87%AA%E5%A2%9E%E9%94%81/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://createsequence.github.io/2020/11/16/mysql/%E3%80%8AMySQL45%E8%AE%B2%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89%EF%BC%9A%E8%87%AA%E5%A2%9E%E4%B8%BB%E9%94%AE%EF%BC%8C%E8%87%AA%E5%A2%9E%E9%94%81/","path":"2020/11/16/mysql/《MySQL45讲》读书笔记（十三）：自增主键，自增锁/","title":"《MySQL45讲》读书笔记(十三)：自增主键，自增锁"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>《MySQL45讲》读书笔记(十三)：自增主键，自增锁 | Createsequence's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
  <!-- 引入目录截取js -->
  <script type="text/javascript" src="/js/custom.js"></script>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Createsequence's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E8%87%AA%E5%A2%9E%E5%80%BC%E7%9A%84%E4%BF%9D%E5%AD%98%E6%96%B9%E5%BC%8F"><span class="nav-text">一、自增值的保存方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E8%87%AA%E5%A2%9E%E5%80%BC%E7%9A%84%E8%87%AA%E5%A2%9E%E6%9C%BA%E5%88%B6"><span class="nav-text">二、自增值的自增机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E8%87%AA%E5%A2%9E%E9%94%81%E5%92%8C%E9%87%8A%E6%94%BE%E7%AD%96%E7%95%A5"><span class="nav-text">三、自增锁和释放策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E4%BA%8B%E5%8A%A1%E5%9B%9E%E6%BB%9A%E5%AF%BC%E8%87%B4%E8%87%AA%E5%A2%9E%E4%B8%8D%E8%BF%9E%E7%BB%AD"><span class="nav-text">四、事务回滚导致自增不连续</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E7%9A%84%E7%94%B3%E8%AF%B7%E7%AD%96%E7%95%A5"><span class="nav-text">五、批量插入的申请策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-text">六、总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%87%AA%E5%A2%9E%E4%B8%BB%E9%94%AE%E4%BF%9D%E5%AD%98%E5%92%8C%E5%A2%9E%E9%95%BF%E7%AD%96%E7%95%A5"><span class="nav-text">1.自增主键保存和增长策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%87%AA%E5%A2%9E%E9%94%81%E7%9A%84%E5%8A%A0%E9%94%81%E7%AD%96%E7%95%A5"><span class="nav-text">2.自增锁的加锁策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%87%AA%E5%A2%9E%E4%B8%BB%E9%94%AE%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E5%8F%AF%E8%83%BD%E6%80%A7"><span class="nav-text">3.自增主键不一致的可能性</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Createsequence"
      src="/images/Createsequence.jpg">
  <p class="site-author-name" itemprop="name">Createsequence</p>
  <div class="site-description" itemprop="description">一个努力前进的程序猿</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">99</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Createsequence" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Createsequence" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://createsequence.github.io/2020/11/16/mysql/%E3%80%8AMySQL45%E8%AE%B2%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89%EF%BC%9A%E8%87%AA%E5%A2%9E%E4%B8%BB%E9%94%AE%EF%BC%8C%E8%87%AA%E5%A2%9E%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Createsequence.jpg">
      <meta itemprop="name" content="Createsequence">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Createsequence's Blog">
      <meta itemprop="description" content="一个努力前进的程序猿">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="《MySQL45讲》读书笔记(十三)：自增主键，自增锁 | Createsequence's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          《MySQL45讲》读书笔记(十三)：自增主键，自增锁
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-16 00:00:00" itemprop="dateCreated datePublished" datetime="2020-11-16T00:00:00+08:00">2020-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2020-12-24 20:01:38" itemprop="dateModified" datetime="2020-12-24T20:01:38+08:00">2020-12-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><blockquote>
<p>此文为极客时间：MySQL实战45讲的39节的学习笔记</p>
</blockquote>
<h2 id="一、自增值的保存方式"><a href="#一、自增值的保存方式" class="headerlink" title="一、自增值的保存方式"></a>一、自增值的保存方式</h2><p>我们前面提到过，自增主键的连续性使得表在空间上排列的更紧密，提高了空间利用率，避免了页分裂。实际上，自增主键大部分情况下可以保证连续性，但是也有例外的时候。</p>
<p>当我们创建表的时候，表结构会存储在 .frm 文件中，但是并不会一起保存自增值。<strong>MyISAM 引擎将自增值保存在数据文件</strong>，而 innodb 在 mysql8.0 之前只会<strong>将自增值保存在内存</strong>。</p>
<p>也就是说，对于 innodb 引擎来说，每次重启后，都需要<strong>寻找表中最大的自增值 X，将 X+1 作为新的自增值</strong>，如果当前最大值为 10，自增值就会是11，如果删除了自增值为 10 的行，那么此时重启数据库，新插入的行自增值就会变成11，当自增值是主键的时候，相当于从新增变成了更新。</p>
<p><strong>而 8.0 以后，innodb 会将自增值的变更记录到 redo log，重启以后依靠日志重做</strong>。</p>
<h2 id="二、自增值的自增机制"><a href="#二、自增值的自增机制" class="headerlink" title="二、自增值的自增机制"></a>二、自增值的自增机制</h2><p>在 mysql 中，如果字段 id 被定义为 AUTO_INCREMENT，那么插入时：</p>
<ol>
<li>如果插入数据时 id 字段指定为 <strong>0、null 或未指定值</strong>，那么就把这个表当前的 AUTO_INCREMENT 值填到自增字段；</li>
<li>如果插入数据时 id 字段指定了具体的值，就直接使用语句里指定的值。</li>
</ol>
<p>根据要插入的值和当前自增值的大小关系，自增值的变更结果也会有所不同。假设，某次要插入的值是 X，当前的自增值是 Y。</p>
<ol>
<li>如果 X&lt;Y，那么这个表的自增值不变；</li>
<li>如果 X≥Y，就需要<strong>把当前自增值修改为新的自增值</strong>。</li>
</ol>
<p>其中，有 <code>auto_increment_offset</code> 和 <code>auto_increment_increment</code> ，分别表示自增值的<strong>初始值</strong>和自增的<strong>步长</strong>，一般默认为1，如果是在一些特殊的情况下：比如双 master 的结构下，就会将其中一个库的 <code>auto_increment_offset</code>  设置为2，让一个库的自增 id 都是奇数，另一个库的自增 id 都是偶数，避免两个库生成的主键发生冲突。</p>
<p>当需要自增的时候，会在<code>auto_increment_offset</code> 的基础上，累加<code>auto_increment_increment</code> ，直到找到第一个比插入值 X 大的数作为新的自增值。</p>
<h2 id="三、自增锁和释放策略"><a href="#三、自增锁和释放策略" class="headerlink" title="三、自增锁和释放策略"></a>三、自增锁和释放策略</h2><p>为了在并发条件下维护自增值的有序性，mysql 引入自增锁。在 mysql 5.1.22 之前的版本，当有需要获取自增值的 sql ——而不是事务——要执行的时候，就会<strong>为计数器加一个表锁，在锁释放前这张表不会有新的 sql 能获得到新的值</strong>。很显然，这个和表的读写锁一样，在<strong>大量 sql 同时请求的时候比较容易发生堵塞</strong>。</p>
<p>mysql 在5.1.22 版本引入了一个新策略，新增参数 <code>innodb_autoinc_lock_mode</code>，默认值是 1。</p>
<ol>
<li>设置为 0：表示采用之前 MySQL 5.0 版本的策略，即<strong>语句执行结束后才释放锁</strong>；</li>
<li>设置为 1：分两种情况<ul>
<li><strong>普通 insert 语句，自增锁在申请之后就马上释放</strong>；</li>
<li>类似 insert … select 这样的<strong>批量插入数据的语句，自增锁还是要等语句结束后才被释放</strong>；</li>
</ul>
</li>
<li>设置为 2：所有的申请自增主键的动作都是<strong>申请后就释放锁</strong>。</li>
</ol>
<p>这个策略的疑问在于，为什么 insert … select 不可以直接使用第三种策略，申请以后就释放？</p>
<p>假如现在有以下的时序图：</p>
<p><img src="http://img.xiajibagao.top/image-20201112202134714.png" alt="自增锁的加锁策略"></p>
<p>假如在第三个时刻：</p>
<ol>
<li>sessionB 已经写入了（1,1,1）和（2,2,2）；</li>
<li>此时 sessionA 写入了 （3,5,5）；</li>
<li>sessionB 继续写入（4,3,3）和（5,4,4）；</li>
</ol>
<p>也就是说，在表 t 上的数据应该是（1,1,1）（2,2,2）（3,3,3）（4,4,4），但是写到表 t2 变成了（1,1,1）（2,2,2）3,5,5）（4,3,3）（5,4,4）</p>
<p>考虑到 sessionB 的语义并没有强制要求 t2 与 t1 相同，所以这不是大问题，但是这样的行为反应到 binlog 就有问题了：</p>
<p>一般情况下，binlog 默认为 statement ，即记录 sql，在<strong>实际上两个 sql 是并行执行的，但是在 binlog 上是串行写入</strong>的，不管是谁先谁后，使用 binlog 恢复的备份里，<strong>表 t2 的数据都会和原来的数据库不一致</strong>。 </p>
<p>发生这个问题的根本原因在于 <strong>sessionB 的 insert…select 这一条语句批量插入数据的 id 是不连续的</strong>，如果要避免这个问题，有两个办法：</p>
<ul>
<li>从根本上解决：让 insert…select 拿到的自增值一定是连续的，方案就是<strong>让锁等 sql 执行完才提交</strong>；</li>
<li>解决出问题的人：<strong>把 binlog 改为 row</strong>，直接记录数据的变化，避免恢复备份是数据出错。</li>
</ul>
<p>为了并发性能考虑，一般情况下，都选择 <strong><code>binlog_format = row</code></strong> + <strong><code>innodb_autoinc_lock_mode = 2</code></strong> 的模式。</p>
<h2 id="四、事务回滚导致自增不连续"><a href="#四、事务回滚导致自增不连续" class="headerlink" title="四、事务回滚导致自增不连续"></a>四、事务回滚导致自增不连续</h2><p>一般情况下，以自增值为主键的表插入一条 id 为 null 的记录的过程如下：</p>
<ol>
<li>执行器调用 innodb 引擎，写入一行；</li>
<li>innodb 发现没指定主键，获取要插入的表的自增值；</li>
<li>将自增值赋给要插入的新数据作为主键；</li>
<li>自增值自增；</li>
<li>完成插入。</li>
</ol>
<p>实际上，如果因为一些其他的情况，导致第五步没有执行，就会导致自增值增加了，但是上一个自增值却没有对应的数据。比如第五步的时候发现<strong>唯一索引冲突</strong>，或者插入完以后<strong>事务回滚</strong>。</p>
<p>实际上，事务回滚理论上应该回滚完全部的数据，但是却没有回滚自增值，是为了性能上的考虑：</p>
<p>假如事务A和事务B分别申请了2和3这两个值作为id，现在自增值为4，<strong>如果事务A发生回滚，而事务B提交了，此时就会出现自增值回滚为2，但是已经出现了id&#x3D;3的数据</strong>，那么下一条插入的数据就会因此id&#x3D;3这个主键冲突而插入失败。</p>
<p>如果要解决这个问题，那么方法有两种：</p>
<ol>
<li>每次插入前扫描一下主键，是否存在同值，有就跳过；</li>
<li>把自增锁从语句级别扩大到事务级别，必须先等上一个事务提交，下一个事务的 sql 才能获取新的自增值；</li>
</ol>
<p>这两种方法都非常影响性能，所以 mysql 事务回滚不会回滚自增值，<strong>自增值只能保证递增有序，不能保证连续。</strong></p>
<h2 id="五、批量插入的申请策略"><a href="#五、批量插入的申请策略" class="headerlink" title="五、批量插入的申请策略"></a>五、批量插入的申请策略</h2><p>insert..select 语句之所以需要加锁，是因为<strong>无法确定到底要插入多少条数据</strong>，对于 insert……values (),(),() 这样语句来说，由于一开始就能确定有多少条要插入，可以直接申请对应数量的自增值。</p>
<p>实际上，mysql 针对 insert…select 这样不确定数量的批量插入也有申请自增id的策略：</p>
<ol>
<li>语句执行过程中，第一次申请自增 id，会分配 1 个；</li>
<li>1 个用完以后，这个语句第二次申请自增 id，会分配 2 个；</li>
<li>2 个用完以后，还是这个语句，第三次申请自增 id，会分配 4 个；</li>
<li>依此类推，同一个语句去申请自增 id，<strong>每次申请到的自增 id 个数都是上一次的两倍</strong>。</li>
</ol>
<p>我们举个例子：假如 sessionA 要执行 insert…select 语句，需要插入四次。在第三次申请 id 的时候，自增 id 就会变成 2 + 4 &#x3D; 6，如果这个时候来了另一个 sessionB 要插入数据，就会直接插入 7，等到 sessionB 提交了以后，sessionA 第四次要申请的时候，自增id就会从8开始，也就说，<strong>4和5这个id就被跳过了，这也会导致出现自增主键的“空洞”</strong>。</p>
<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><h3 id="1-自增主键保存和增长策略"><a href="#1-自增主键保存和增长策略" class="headerlink" title="1.自增主键保存和增长策略"></a>1.自增主键保存和增长策略</h3><p>mysql 8.0 之前自增值保存在内存里，重启以后会获取表的最大值，在最大值基础上+1。8.0 之后可以通过 redo log 重做获得最新的自增值。</p>
<p><code>auto_increment_offset</code> 和 <code>auto_increment_increment</code> 分别表示自增值的初始值和自增的步长，当插入记录已经指明了自增值的时候，则会直接使用插入值，并且比较该值与最新初始值的大小，如果初始值小，则会累加步长直到比插入值大位置，反正就不改变初始值，下次插入还用它。</p>
<p>事务回滚不会回滚自增值，这样做是为了避免先进行的事务回滚，导致自增值回滚后小于最新数据自增id，下一次插入可能会出现主键冲突。</p>
<h3 id="2-自增锁的加锁策略"><a href="#2-自增锁的加锁策略" class="headerlink" title="2.自增锁的加锁策略"></a>2.自增锁的加锁策略</h3><p>mysql 针对自增锁有三种策略，根据<code>innodb_autoinc_lock_mode</code>设置：</p>
<ul>
<li>设置为 0 ：语句结束后释放自增锁；</li>
<li>设置为 1：普通 insert 申请后立刻释放； insert … select 这样批量插入的语句会等到执行完后才释放；</li>
<li>设置为 2：不分普通和批量插入，语句获取锁后都立刻释放锁；</li>
</ul>
<p>当有插入的 sql 和批量插入并发写的时候，可能会出现自增主键连续，但是 binlog 备份恢复出来的数据库跟原库不一致，这种情况最好选择 <code>statement + innodb_autoinc_lock_mode = 2</code></p>
<h3 id="3-自增主键不一致的可能性"><a href="#3-自增主键不一致的可能性" class="headerlink" title="3.自增主键不一致的可能性"></a>3.自增主键不一致的可能性</h3><p>mysql 针对确定数量的批量插入是可以直接申请一大批自增值的，但是针对不确定的插入，会每次插入都申请两倍于上一次插入申请的数量的自增主键。</p>
<p>综上，主键不自增有可能有两种情况：</p>
<ul>
<li>插入失败，事务回滚导致申请了的自增值没用上；</li>
<li>批量插入申请了大量主键，中途其他事务插入导致自增值被迫维持在最大值；</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"># mysql</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/11/15/mysql/%E3%80%8AMySQL45%E8%AE%B2%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89%EF%BC%9Aorder%20by/" rel="prev" title="《MySQL45讲》读书笔记(十二)：order by">
                  <i class="fa fa-angle-left"></i> 《MySQL45讲》读书笔记(十二)：order by
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/11/17/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%B5%84%E6%BA%90%E6%8E%A8%E8%8D%90%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%86%85%E6%A0%B8%E6%9C%88%E6%8A%A5/" rel="next" title="资源推荐：数据库内核月报">
                  资源推荐：数据库内核月报 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Createsequence</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">261k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">15:47</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
